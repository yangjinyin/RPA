# 一. Server层加密

即在fill_record()阶段对数据加密

```sql
mysql>INSERT INTO users (username, password)
    -> VALUES ('alice', AES_ENCRYPT('mypassword', 'mysecretkey'));
Query OK, 1 row affected (0.01 sec)

mysql> select * from users;
+----+----------+------------------+
| id | username | password         |
+----+----------+------------------+
|  1 | alice    | ��Bn�����l����� |
+----+----------+------------------+
1 row in set (0.00 sec)

mysql> SELECT username, AES_DECRYPT(password, 'mysecretkey') AS decrypted_password
    -> FROM users;
+----------+--------------------+
| username | decrypted_password |
+----------+--------------------+
| alice    | mypassword         |
+----------+--------------------+
1 row in set (0.00 sec)
```

调用逻辑

```c++
|-->Sql_cmd_insert_values::execute_inner()
|		|-->fill_record_n_invoke_before_triggers()
|		|		|-->fill_record()
|		|		|		|-->Item::save_in_field()
|		|		|		|		|-->Item::save_in_field_inner()
|		|		|		|		|		|-->Item_func_aes_encrypt::val_str()
|		|		|		|		|		|		|-->my_aes_encrypt()
```



# 二： innodb层加密

支持对表空间，通用表空间，系统表空间，redo log，undolog 加密

#### 2.1 启动时会进行判断

```c++
static int innodb_init(void *p)
{
  ....
  /* Check for keyring plugin if UNDO/REDO logs are intended to be encrypted */
  if ((srv_undo_log_encrypt || srv_redo_log_encrypt) &&
      Encryption::check_keyring() == false) {
    return innodb_init_abort();
  }
}
```

在创建或更改模式时，也可以使用子句定义模式的默认加密设置`DEFAULT ENCRYPTION`，如下例所示：

```sql
mysql> CREATE SCHEMA test DEFAULT ENCRYPTION = 'Y';
```

#### 每个表的文件表空间加密

`ENCRYPTION`必须指定该子句才能启用加密。

```sql
mysql> CREATE TABLE t1 (c1 INT) ENCRYPTION = 'Y';
```

要更改现有的每个表文件表空间的加密，`ENCRYPTION`必须指定一个子句。

```sql
mysql> ALTER TABLE t1 ENCRYPTION = 'Y';
```

### 通用表空间加密

要改变现有通用表空间的加密， `ENCRYPTION`必须指定一个子句。

```sql
mysql> ALTER TABLESPACE ts1 ENCRYPTION = 'Y';
```

### 双写文件加密

`InnoDB`自动加密属于加密表空间的双写文件页面。无需任何操作。双写文件页面使用关联表空间的加密密钥进行加密。写入表空间数据文件的加密页面也会写入双写文件。属于未加密表空间的双写文件页面保持未加密状态。

在恢复过程中，加密的双写文件页面将被解密并检查是否损坏。

### 系统表空间加密

`mysql`表空间包含 `mysql`系统数据库和 MySQL 数据字典表。默认情况下，它未加密。要为系统表空间启用加密 ，请在 语句中`mysql`指定表空间名称和选项

```sql
mysql> ALTER TABLESPACE mysql ENCRYPTION = 'Y';
```

要禁用`mysql`系统表空间的加密

```sql
mysql> ALTER TABLESPACE mysql ENCRYPTION = 'N';
```

### REDO-log加密

使用配置选项启用重做日志数据加密 [`innodb_redo_log_encrypt`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_redo_log_encrypt) 。默认情况下，重做日志加密是禁用的。

与表空间数据一样，重做日志数据加密发生在将重做日志数据写入磁盘时，解密发生在从磁盘读取重做日志数据时。重做日志数据读入内存后，将处于未加密状态。重做日志数据使用表空间加密密钥进行加密和解密。

redo加密元数据，包括tablespace的加密key 在8.0.30后存放在最新lsn所在文件header中。8.0.30以前是存放在ib_logfile0。

一旦启用重做日志加密，在没有密钥环组件或插件或加密密钥的情况下，无法正常重启。

### Undo Log Encryption

[`innodb_undo_log_encrypt`](https://dev.mysql.com/doc/refman/8.0/en/innodb-parameters.html#sysvar_innodb_undo_log_encrypt) 

undo加密元数据，包括tablespace的加密key 存放在undo log的头文件中

### 识别加密的表空间和模式

```sql
mysql> SELECT SPACE, NAME, SPACE_TYPE, ENCRYPTION FROM INFORMATION_SCHEMA.INNODB_TABLESPACES
       WHERE ENCRYPTION='Y'\G
*************************** 1. row ***************************
     SPACE: 4294967294
      NAME: mysql
SPACE_TYPE: General
ENCRYPTION: Y
```



